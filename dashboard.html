<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | HK Window Pros</title>

<style>
  body, html {
    height: 100%;
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background-color: #f0f6ff;
    display: flex;
    flex-direction: column;
  }
  header {
    background: linear-gradient(90deg, #007BFF, #0056b3);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
  }
  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }
  button.logout-btn {
    background: #e03c3c;
    border: none;
    color: white;
    padding: 0.5rem 1.2rem;
    border-radius: 5px;
    font-weight: 700;
    cursor: pointer;
  }
  button.logout-btn:hover {
    background: #a32a2a;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem 2rem;
    max-width: 1200px;
    margin: auto;
    gap: 1.5rem;
    box-sizing: border-box;
  }
  /* Tabs for job status */
  .tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .tab-btn {
    padding: 0.5rem 1rem;
    background: #dbe7ff;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    color: #0056b3;
    transition: background-color 0.3s;
  }
  .tab-btn.active,
  .tab-btn:hover {
    background: #1a40af;
    color: white;
  }
  /* Jobs container */
  .jobs-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(26,64,175,0.15);
    padding: 1rem 1.5rem;
    max-height: 300px;
    overflow-y: auto;
  }
  .job-item {
    border-bottom: 1px solid #ddd;
    padding: 0.8rem 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .job-item:last-child {
    border-bottom: none;
  }
  .job-item:hover {
    background-color: #e6f0ff;
  }
  .job-name {
    font-weight: 700;
    font-size: 1.1rem;
    color: #003f7f;
  }
  .job-details {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0.2rem;
  }
  /* Add Job button */
  #addJobBtn {
    align-self: flex-start;
    padding: 0.5rem 1rem;
    background: #1a40af;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 1rem;
  }
  #addJobBtn:hover {
    background: #15327a;
  }
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 10px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    position: relative;
  }
  .modal-content h2 {
    margin-top: 0;
    color: #1a40af;
  }
  .modal-content label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }
  .modal-content input, .modal-content select, .modal-content textarea {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.3rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
    box-sizing: border-box;
  }
  .modal-content textarea {
    resize: vertical;
    min-height: 60px;
  }
  .modal-actions {
    margin-top: 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
  }
  .btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
  }
  .btn.cancel-btn {
    background: #ccc;
    color: #444;
  }
  .btn.cancel-btn:hover {
    background: #999;
  }
  .btn.save-btn {
    background: #1a40af;
    color: white;
  }
  .btn.save-btn:hover {
    background: #15327a;
  }
  /* Weekly calendar */
  section.weekly-calendar {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(26,64,175,0.15);
    padding: 1rem 1.5rem;
    overflow-x: auto;
  }
  #weeklyCalendar {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-top: 0.5rem;
  }
  .day-col {
    min-width: 130px;
    background: #f9faff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.5rem;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    flex-shrink: 0;
  }
  .day-label {
    font-weight: 700;
    margin-bottom: 0.6rem;
    color: #0056b3;
  }
  .calendar-job {
    background: #e6f0ff;
    padding: 0.4rem;
    margin-bottom: 0.4rem;
    border-radius: 4px;
    cursor: pointer;
  }
  .calendar-job:hover {
    background: #c3d1ff;
  }
</style>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD4_934C9L4kyEGHT5jDaCxNPHGC-HjIj4",
    authDomain: "hk-windows.firebaseapp.com",
    projectId: "hk-windows",
    storageBucket: "hk-windows.firebasestorage.app",
    messagingSenderId: "955997236305",
    appId: "1:955997236305:web:b59d35b1f5f43a40ccdc70",
    measurementId: "G-JPPBZW9LW8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Elements
  const logoutBtn = document.getElementById("logoutBtn");
  const addJobBtn = document.getElementById("addJobBtn");
  const modal = document.getElementById("jobModal");
  const modalTitle = document.getElementById("modalTitle");
  const jobForm = document.getElementById("jobForm");
  const jobsContainers = {
    pending: document.getElementById("pendingJobs"),
    inprogress: document.getElementById("inprogressJobs"),
    completed: document.getElementById("completedJobs"),
  };
  const tabs = document.querySelectorAll(".tab-btn");
  const weeklyCalendar = document.getElementById("weeklyCalendar");

  let editingJobId = null;

  // Current logged-in user email (auth-based)
  let currentUserEmail = null;

  // Allowed users to see/edit jobs (emails lowercase)
  const allowedUsers = ["rejat@example.com", "nick@example.com"];

  // Redirect if not logged in
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      currentUserEmail = user.email.toLowerCase();
      if (!allowedUsers.includes(currentUserEmail)) {
        alert("You do not have permission to access this dashboard.");
        signOut(auth);
        return;
      }
      loadJobsRealtime();
    }
  });

  logoutBtn.onclick = () => {
    signOut(auth);
  };

  // Switch tabs
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      showTab(tab.dataset.status);
    });
  });

  function showTab(status) {
    Object.entries(jobsContainers).forEach(([key, container]) => {
      container.style.display = (key === status) ? "block" : "none";
    });
  }

  // Initialize showing pending jobs
  showTab("pending");
  tabs[0].classList.add("active");

  // Load jobs from Firestore realtime & display
  function loadJobsRealtime() {
    const jobsRef = collection(db, "quotes");
    const q = query(jobsRef, orderBy("serviceDate", "asc"));

    onSnapshot(q, (snapshot) => {
      const allJobs = [];
      snapshot.forEach(docSnap => {
        const job = docSnap.data();
        job.id = docSnap.id;
        allJobs.push(job);
      });

      renderJobs(allJobs);
      renderWeeklyCalendar(allJobs);
    });
  }

  // Render jobs into their containers by status
  function renderJobs(jobs) {
    // Clear containers
    Object.values(jobsContainers).forEach(c => c.innerHTML = "");

    jobs.forEach(job => {
      // Show job only if it's assigned to allowed users or no restriction
      // (or you can implement a field for assigned users)
      if (!allowedUsers.includes(currentUserEmail)) return;

      const status = (job.status || "pending").toLowerCase();
      if (!jobsContainers[status]) return; // skip unknown status

      const jobDiv = document.createElement("div");
      jobDiv.className = "job-item";
      jobDiv.dataset.id = job.id;
      jobDiv.innerHTML = `
        <div class="job-name">${job.name}</div>
        <div class="job-details">
          Date: ${job.serviceDate || "N/A"}<br />
          Time: ${job.timeSlot || "N/A"}<br />
          Pay: $${job.pay?.toFixed(2) || "0.00"}<br />
          Windows: ${job.windows || 0}<br />
          Duration: ${job.durationHours?.toFixed(1) || "0"} hrs<br />
          Location: ${job.location || "TBD"}
        </div>
      `;

      jobDiv.onclick = () => openModal(job);

      jobsContainers[status].appendChild(jobDiv);
    });
  }

  // Open modal for adding/editing
  function openModal(job = null) {
    modal.classList.add("active");
    editingJobId = null;

    if (job) {
      modalTitle.textContent = "Edit Job";
      jobForm.name.value = job.name || "";
      jobForm.email.value = job.email || "";
      jobForm.phone.value = job.phone || "";
      jobForm.serviceDate.value = job.serviceDate || "";
      jobForm.timeSlot.value = job.timeSlot || "";
      jobForm.pay.value = job.pay || "";
      jobForm.windows.value = job.windows || "";
      jobForm.durationHours.value = job.durationHours || "";
      jobForm.location.value = job.location || "";
      jobForm.status.value = (job.status || "pending");
      editingJobId = job.id;
    } else {
      modalTitle.textContent = "Add New Job";
      jobForm.reset();
      jobForm.status.value = "pending";
    }
  }

  // Close modal
  document.getElementById("modalClose").onclick = () => {
    modal.classList.remove("active");
    editingJobId = null;
  };
  // Also close if clicking outside modal-content
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.classList.remove("active");
      editingJobId = null;
    }
  };

  // Add job button
  addJobBtn.onclick = () => openModal();

  // Save job (add or update)
  jobForm.onsubmit = async (e) => {
    e.preventDefault();
    const data = {
      name: jobForm.name.value.trim(),
      email: jobForm.email.value.trim(),
      phone: jobForm.phone.value.trim(),
      serviceDate: jobForm.serviceDate.value,
      timeSlot: jobForm.timeSlot.value,
      pay: parseFloat(jobForm.pay.value) || 0,
      windows: parseInt(jobForm.windows.value) || 0,
      durationHours: parseFloat(jobForm.durationHours.value) || 0,
      location: jobForm.location.value.trim() || "TBD",
      status: jobForm.status.value.toLowerCase() || "pending",
      createdBy: currentUserEmail,
      createdAt: new Date().toISOString()
    };

    try {
      if (editingJobId) {
        const jobDoc = doc(db, "quotes", editingJobId);
        await updateDoc(jobDoc, data);
      } else {
        await addDoc(collection(db, "quotes"), data);
      }
      modal.classList.remove("active");
      editingJobId = null;
    } catch (err) {
      alert("Error saving job: " + err.message);
    }
  };

  // Weekly calendar rendering
  function getMonday(d) {
    d = new Date(d);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    return new Date(d.setDate(d.getDate() + diff));
  }
  function formatDayLabel(date) {
    const options = { weekday: "short", month: "numeric", day: "numeric" };
    return date.toLocaleDateString(undefined, options);
  }
  function formatJobDisplay(job) {
    return `${job.name} (${job.timeSlot || "No time"})`;
  }
  function renderWeeklyCalendar(jobs) {
    weeklyCalendar.innerHTML = "";
    const monday = getMonday(new Date());

    for (let i = 0; i < 7; i++) {
      const dayDate = new Date(monday);
      dayDate.setDate(monday.getDate() + i);

      const dayJobs = jobs.filter(job => {
        if (!job.serviceDate) return false;
        const jobDate = new Date(job.serviceDate);
        return jobDate.toDateString() === dayDate.toDateString();
      });

      const dayCol = document.createElement("div");
      dayCol.className = "day-col";

      const dayLabel = document.createElement("div");
      dayLabel.className = "day-label";
      dayLabel.textContent = formatDayLabel(dayDate);
      dayCol.appendChild(dayLabel);

      if (dayJobs.length === 0) {
        const noJobs = document.createElement("div");
        noJobs.style.color = "#999";
        noJobs.textContent = "No jobs";
        dayCol.appendChild(noJobs);
      } else {
        dayJobs.forEach(job => {
          const jobDiv = document.createElement("div");
          jobDiv.className = "calendar-job";
          jobDiv.textContent = formatJobDisplay(job);
          jobDiv.onclick = () => openModal(job);
          dayCol.appendChild(jobDiv);
        });
      }

      weeklyCalendar.appendChild(dayCol);
    }
  }
</script>

</head>
<body>

<header>
  <h1>Dashboard</h1>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</header>

<main>
  <button id="addJobBtn">+ Add Job</button>

  <div class="tabs">
    <button class="tab-btn" data-status="pending">Pending Jobs</button>
    <button class="tab-btn" data-status="inprogress">In Progress Jobs</button>
    <button class="tab-btn" data-status="completed">Completed Jobs</button>
  </div>

  <div id="pendingJobs" class="jobs-container"></div>
  <div id="inprogressJobs" class="jobs-container" style="display:none;"></div>
  <div id="completedJobs" class="jobs-container" style="display:none;"></div>

  <section class="weekly-calendar">
    <h2>Weekly Calendar</h2>
    <div id="weeklyCalendar"></div>
  </section>
</main>

<!-- Job Add/Edit Modal -->
<div class="modal" id="jobModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h2 id="modalTitle">Add/Edit Job</h2>
    <form id="jobForm">
      <label for="name">Job Name*</label>
      <input id="name" name="name" required type="text" placeholder="Job name" />

      <label for="email">Customer Email</label>
      <input id="email" name="email" type="email" placeholder="customer@example.com" />

      <label for="phone">Customer Phone</label>
      <input id="phone" name="phone" type="tel" placeholder="555-123-4567" />

      <label for="serviceDate">Service Date*</label>
      <input id="serviceDate" name="serviceDate" type="date" required />

      <label for="timeSlot">Time Slot</label>
      <input id="timeSlot" name="timeSlot" type="text" placeholder="e.g., 9:00 AM - 11:00 AM" />

      <label for="pay">Pay ($)</label>
      <input id="pay" name="pay" type="number" step="0.01" min="0" placeholder="120.00" />

      <label for="windows">Number of Windows</label>
      <input id="windows" name="windows" type="number" min="0" placeholder="30" />

      <label for="durationHours">Estimated Duration (hrs)</label>
      <input id="durationHours" name="durationHours" type="number" step="0.1" min="0" placeholder="1.5" />

      <label for="location">Job Location</label>
      <textarea id="location" name="location" placeholder="Address or location details"></textarea>

      <label for="status">Status</label>
      <select id="status" name="status">
        <option value="pending">Pending</option>
        <option value="inprogress">In Progress</option>
        <option value="completed">Completed</option>
      </select>

      <div class="modal-actions">
        <button type="button" class="btn cancel-btn" id="modalClose">Cancel</button>
        <button type="submit" class="btn save-btn">Save Job</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>
