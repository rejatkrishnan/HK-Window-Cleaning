<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | HK Window Pros</title>
<style>
  body, html {
    margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #f0f6ff;
    min-height: 100vh; display: flex; flex-direction: column;
  }
  header {
    background: #1a40af; color: white; padding: 1rem 2rem;
    display: flex; justify-content: space-between; align-items: center;
  }
  header h1 { margin: 0; font-size: 1.8rem; }
  button.logout-btn {
    background: #e03c3c; border: none; color: white;
    padding: 0.5rem 1.2rem; border-radius: 5px; font-weight: 700;
    cursor: pointer;
  }
  button.logout-btn:hover { background: #a32a2a; }
  main {
    flex: 1; max-width: 1200px; margin: 1rem auto; width: 90%;
  }
  .tabs {
    display: flex; gap: 1rem; margin-bottom: 1rem;
  }
  .tab-btn {
    padding: 0.6rem 1.2rem; border: none; border-radius: 6px;
    background: #dbe7ff; color: #003f7f; font-weight: 700;
    cursor: pointer; flex: 1; transition: background-color 0.3s;
  }
  .tab-btn.active, .tab-btn:hover {
    background: #1a40af; color: white;
  }
  #jobsContainer {
    background: white; border-radius: 10px; padding: 1rem;
    box-shadow: 0 4px 15px rgba(26,64,175,0.15);
    max-height: 70vh; overflow-y: auto;
  }
  .job-item {
    border-bottom: 1px solid #ddd; padding: 0.75rem 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  .job-info {
    flex: 1;
  }
  .job-name {
    font-weight: 700; font-size: 1.1rem; margin: 0 0 0.3rem 0;
    color: #003f7f;
  }
  .job-details {
    font-size: 0.9rem; color: #555;
    margin: 0;
  }
  .job-actions button {
    margin-left: 0.5rem; padding: 0.3rem 0.7rem;
    border: none; border-radius: 4px; cursor: pointer;
    font-weight: 700; font-size: 0.85rem;
  }
  .btn-edit { background: #007bff; color: white; }
  .btn-edit:hover { background: #0056b3; }
  .btn-move { background: #28a745; color: white; }
  .btn-move:hover { background: #1e7e34; }

  /* Modal Styles */
  .modal-bg {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 1000;
    justify-content: center; align-items: center;
  }
  .modal-bg.active { display: flex; }
  .modal {
    background: white; padding: 1.5rem; border-radius: 10px; width: 400px;
    max-width: 90vw; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    position: relative;
  }
  .modal h2 {
    margin-top: 0; color: #1a40af; font-weight: 700;
  }
  .modal label {
    display: block; margin-top: 1rem; font-weight: 700;
  }
  .modal input, .modal select {
    width: 100%; padding: 0.5rem; margin-top: 0.3rem;
    border-radius: 5px; border: 1px solid #ccc;
  }
  .modal-buttons {
    margin-top: 1.5rem; text-align: right;
  }
  .modal-buttons button {
    padding: 0.5rem 1rem; margin-left: 0.5rem;
    border: none; border-radius: 5px; font-weight: 700;
    cursor: pointer;
  }
  .btn-cancel { background: #bbb; color: #333; }
  .btn-cancel:hover { background: #999; }
  .btn-save { background: #1a40af; color: white; }
  .btn-save:hover { background: #15327a; }

  /* Add Job Button */
  #addJobBtn {
    background: #1a40af; color: white; font-weight: 700;
    padding: 0.7rem 1.2rem; border: none; border-radius: 6px;
    cursor: pointer; margin-bottom: 1rem;
  }
  #addJobBtn:hover { background: #15327a; }

  /* Scrollbar styling for jobs container */
  #jobsContainer::-webkit-scrollbar {
    width: 8px;
  }
  #jobsContainer::-webkit-scrollbar-thumb {
    background-color: #1a40af;
    border-radius: 4px;
  }
</style>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD4_934C9L4kyEGHT5jDaCxNPHGC-HjIj4",
    authDomain: "hk-windows.firebaseapp.com",
    projectId: "hk-windows",
    storageBucket: "hk-windows.firebasestorage.app",
    messagingSenderId: "955997236305",
    appId: "1:955997236305:web:b59d35b1f5f43a40ccdc70",
    measurementId: "G-JPPBZW9LW8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  // DOM Elements
  const logoutBtn = document.getElementById("logoutBtn");
  const jobsContainer = document.getElementById("jobsContainer");
  const addJobBtn = document.getElementById("addJobBtn");

  const modalBg = document.getElementById("modalBg");
  const modal = document.getElementById("modal");
  const jobForm = document.getElementById("jobForm");

  // Tabs
  const tabButtons = document.querySelectorAll(".tab-btn");
  let currentTab = "pending"; // default

  // Current job being edited (null if adding new)
  let editingJobId = null;

  // Check login state
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      loadJobsRealtime();
    }
  });

  logoutBtn.onclick = () => {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  };

  // Listen for tab changes
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTab = btn.dataset.tab;
      renderJobs(currentTab);
    });
  });

  addJobBtn.onclick = () => {
    openModal();
  };

  // Open modal for add/edit job
  function openModal(job = null) {
    editingJobId = job ? job.id : null;
    modalBg.classList.add("active");
    if (job) {
      jobForm["customerName"].value = job.customerName;
      jobForm["email"].value = job.email;
      jobForm["phone"].value = job.phone;
      jobForm["status"].value = job.status;
      jobForm["date"].value = job.date;
      jobForm["time"].value = job.time;
      jobForm["pay"].value = job.pay;
      jobForm["windows"].value = job.windows;
      jobForm["location"].value = job.location || "";
    } else {
      jobForm.reset();
      jobForm["status"].value = "pending";
    }
  }

  // Close modal
  document.getElementById("modalCloseBtn").onclick = () => {
    modalBg.classList.remove("active");
  };
  modalBg.onclick = e => {
    if (e.target === modalBg) modalBg.classList.remove("active");
  };

  // Add or update job
  jobForm.onsubmit = async (e) => {
    e.preventDefault();
    const data = {
      customerName: jobForm["customerName"].value.trim(),
      email: jobForm["email"].value.trim(),
      phone: jobForm["phone"].value.trim(),
      status: jobForm["status"].value,
      date: jobForm["date"].value,
      time: jobForm["time"].value,
      pay: parseFloat(jobForm["pay"].value),
      windows: parseInt(jobForm["windows"].value),
      location: jobForm["location"].value.trim()
    };

    if(!data.customerName || !data.email || !data.phone || !data.status || !data.date || !data.time || isNaN(data.pay) || isNaN(data.windows)) {
      alert("Please fill all fields correctly.");
      return;
    }

    try {
      if (editingJobId) {
        // update existing
        const docRef = doc(db, "jobs", editingJobId);
        await updateDoc(docRef, data);
      } else {
        // add new
        await addDoc(collection(db, "jobs"), data);
      }
      modalBg.classList.remove("active");
      editingJobId = null;
    } catch (err) {
      alert("Error saving job: " + err.message);
    }
  };

  // Store all jobs here for rendering
  let allJobs = [];

  // Real-time jobs listener
  function loadJobsRealtime() {
    const jobsCol = collection(db, "jobs");
    const q = query(jobsCol, orderBy("date"));
    onSnapshot(q, (snapshot) => {
      allJobs = [];
      snapshot.forEach(docSnap => {
        allJobs.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderJobs(currentTab);
    });
  }

  // Render jobs filtered by status
  function renderJobs(status) {
    jobsContainer.innerHTML = "";
    const filtered = allJobs.filter(j => j.status === status);

    if(filtered.length === 0) {
      jobsContainer.innerHTML = `<p style="text-align:center; color:#555; margin-top:2rem;">No ${capitalize(status)} jobs.</p>`;
      return;
    }

    filtered.forEach(job => {
      const jobDiv = document.createElement("div");
      jobDiv.className = "job-item";

      jobDiv.innerHTML = `
        <div class="job-info">
          <p class="job-name">${escapeHtml(job.customerName)}</p>
          <p class="job-details">
            Status: <strong>${capitalize(job.status)}</strong> | Date: ${job.date} | Time: ${job.time} <br/>
            Pay: $${job.pay.toFixed(2)} | Windows: ${job.windows} <br/>
            Location: ${escapeHtml(job.location || "N/A")} <br/>
            Email: ${escapeHtml(job.email)} | Phone: ${escapeHtml(job.phone)}
          </p>
        </div>
        <div class="job-actions">
          <button class="btn-edit">Edit</button>
          ${job.status !== "completed" ? `<button class="btn-move">${job.status === "pending" ? "Start" : "Complete"}</button>` : ""}
        </div>
      `;

      // Edit button event
      jobDiv.querySelector(".btn-edit").onclick = () => openModal(job);

      // Move status button event
      const moveBtn = jobDiv.querySelector(".btn-move");
      if(moveBtn) {
        moveBtn.onclick = () => moveJobStatus(job);
      }

      jobsContainer.appendChild(jobDiv);
    });
  }

  // Move job status function
  async function moveJobStatus(job) {
    try {
      const nextStatus = job.status === "pending" ? "in progress" : "completed";
      const docRef = doc(db, "jobs", job.id);
      await updateDoc(docRef, { status: nextStatus });
    } catch (err) {
      alert("Error updating job status: " + err.message);
    }
  }

  // Helper to capitalize strings
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</head>
<body>

<header>
  <h1>Dashboard</h1>
  <button id="logoutBtn" class="logout-btn">Logout</button>
</header>

<main>
  <button id="addJobBtn">+ Add Job</button>

  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending</button>
    <button class="tab-btn" data-tab="in progress">In Progress</button>
    <button class="tab-btn" data-tab="completed">Completed</button>
  </div>

  <div id="jobsContainer">
    <!-- Jobs will be listed here -->
  </div>
</main>

<!-- Modal -->
<div id="modalBg" class="modal-bg">
  <div id="modal" class="modal">
    <h2>Add/Edit Job</h2>
    <form id="jobForm">
      <label for="customerName">Customer Name</label>
      <input type="text" id="customerName" name="customerName" required />

      <label for="email">Customer Email</label>
      <input type="email" id="email" name="email" required />

      <label for="phone">Customer Phone</label>
      <input type="tel" id="phone" name="phone" required />

      <label for="status">Status</label>
      <select id="status" name="status" required>
        <option value="pending">Pending</option>
        <option value="in progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>

      <label for="date">Job Date</label>
      <input type="date" id="date" name="date" required />

      <label for="time">Job Time</label>
      <input type="time" id="time" name="time" required />

      <label for="pay">Pay ($)</label>
      <input type="number" step="0.01" id="pay" name="pay" required />

      <label for="windows">Number of Windows</label>
      <input type="number" id="windows" name="windows" required />

      <label for="location">Location (address or notes)</label>
      <input type="text" id="location" name="location" />

      <div class="modal-buttons">
        <button type="button" class="btn-cancel" id="modalCloseBtn">Cancel</button>
        <button type="submit" class="btn-save">Save</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>
