<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HK Window Pros - Reviews</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0; padding: 0;
      background-color: #f4f8ff;
      color: #333;
      line-height: 1.6;
    }
    header {
      background: linear-gradient(90deg, #007BFF, #0056b3);
      color: white;
      padding: 1rem;
      position: relative;
    }
    .header-container {
      max-width: 1100px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .logo-title a {
      display: inline-flex;
      align-items: center;
      gap: 1rem;
      text-decoration: none;
      user-select: none;
      color: white;
    }
    .logo-title img {
      height: 60px;
      width: auto;
    }
    .logo-title h1 {
      margin: 0;
      font-weight: 700;
      font-size: 1.7rem;
    }
    .menu-icon {
      font-size: 1.8rem;
      cursor: pointer;
      display: block;
    }
    nav {
      display: none;
      position: absolute;
      top: 70px;
      right: 1rem;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      z-index: 1000;
      width: 180px;
    }
    nav a {
      display: block;
      padding: 1rem 1.5rem;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    nav a:last-child {
      border-bottom: none;
    }
    nav a:hover {
      background-color: #f4f4f4;
    }
    main {
      max-width: 700px;
      margin: 3rem auto 5rem auto;
      background: white;
      padding: 2.5rem 3rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 1rem;
      font-weight: 700;
      color: #0056b3;
      font-size: 2rem;
      text-align: center;
    }
    form {
      margin-bottom: 2rem;
    }
    label {
      font-weight: 700;
      display: block;
      margin: 1rem 0 0.4rem 0;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .star-rating {
      display: flex;
      gap: 5px;
      margin: 0.5rem 0 1rem 0;
      cursor: pointer;
      justify-content: flex-start;
      user-select: none;
    }
    .star {
      font-size: 1.8rem;
      color: #ccc;
      transition: color 0.2s;
    }
    .star.selected,
    .star:hover,
    .star:hover ~ .star {
      color: #f5b301;
    }
    button {
      background-color: #007BFF;
      color: white;
      padding: 0.9rem 2rem;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 1rem;
    }
    button:hover {
      background-color: #0056b3;
    }
    .reviews-list {
      margin-top: 2rem;
    }
    .review {
      border-bottom: 1px solid #ddd;
      padding: 1rem 0;
      position: relative;
    }
    .review:last-child {
      border-bottom: none;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .review-name {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .review-stars {
      color: #f5b301;
      font-size: 1.2rem;
    }
    .review-text {
      margin-top: 0.4rem;
      font-size: 1rem;
      white-space: pre-wrap;
    }
    .review-date {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.2rem;
    }
    .delete-button {
      background: none;
      border: none;
      color: #cc0000;
      cursor: pointer;
      font-size: 1rem;
      position: absolute;
      right: 0;
      top: 1.2rem;
      padding: 0 0.4rem;
      user-select: none;
      transition: color 0.3s;
    }
    .delete-button:hover {
      color: #ff4444;
    }
    .login-section {
      text-align: right;
      margin-bottom: 1rem;
    }
    .login-section button {
      background-color: #0056b3;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      margin-left: 0.5rem;
      transition: background-color 0.3s ease;
    }
    .login-section button:hover {
      background-color: #003f7f;
    }
    .logged-in-info {
      font-size: 0.9rem;
      margin-right: 0.5rem;
      color: #0056b3;
      font-weight: 700;
      display: inline-block;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background-color: #e0e7ff;
      color: #444;
      font-size: 0.9rem;
      user-select: none;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
      position: fixed;
      width: 100%;
      bottom: 0;
      left: 0;
      z-index: 500;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo-title">
        <a href="index.html">
          <img src="logo.png" alt="HK Window Pros Logo" />
          <h1>HK Window Pros</h1>
        </a>
      </div>
      <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
      <nav id="menu">
        <a href="index.html">Home</a>
        <a href="quote.html">Get a Quote</a>
        <a href="reviews.html">Reviews</a>
        <a href="login.html">Login</a>
      </nav>
    </div>
  </header>

  <main>
    <h2>Customer Reviews</h2>

    <div class="login-section" id="login-section">
      <span class="logged-in-info" id="logged-in-info" style="display:none;"></span>
      <button id="login-button">Login</button>
      <button id="logout-button" style="display:none;">Logout</button>
    </div>

    <form id="review-form" aria-label="Submit a review">
      <label for="name">Name (or leave blank for Anonymous):</label>
      <input type="text" id="name" name="name" placeholder="Your name or Anonymous" maxlength="50" />

      <label>Rating:</label>
      <div class="star-rating" role="radiogroup" aria-labelledby="rating-label" tabindex="0">
        <span class="star" data-value="1" role="radio" aria-checked="false" tabindex="0" aria-label="1 star">&#9733;</span>
        <span class="star" data-value="2" role="radio" aria-checked="false" tabindex="-1" aria-label="2 stars">&#9733;</span>
        <span class="star" data-value="3" role="radio" aria-checked="false" tabindex="-1" aria-label="3 stars">&#9733;</span>
        <span class="star" data-value="4" role="radio" aria-checked="false" tabindex="-1" aria-label="4 stars">&#9733;</span>
        <span class="star" data-value="5" role="radio" aria-checked="false" tabindex="-1" aria-label="5 stars">&#9733;</span>
      </div>

      <label for="review-text">Review:</label>
      <textarea id="review-text" name="review-text" placeholder="Write your review here..." required maxlength="500"></textarea>

      <button type="submit">Submit Review</button>
    </form>

    <div class="reviews-list" id="reviews-list" aria-live="polite" aria-relevant="additions">
      Loading reviews...
    </div>
  </main>

  <footer>
    &copy; 2025 HK Window Pros. All rights reserved.<br/>
    üìû <a href="tel:+16516895866">(651) 689-5866</a> | ‚úâÔ∏è <a href="mailto:hkwindowpros@gmail.com">hkwindowpros@gmail.com</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://xwdtpqyphfhhnfpadhpv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZHRwcXlwaGZoaG5mcGFkaHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTY0MjIsImV4cCI6MjA2OTgzMjQyMn0.dP_7pajnInXt0p5YJES8yVQcZCP81S4V-rP5ozkTHPQ';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const adminUIDs = ['8850a9f8-f11b-417f-8d1c-32d988e4fef3'];

    const loginSection = document.getElementById('login-section');
    const loggedInInfo = document.getElementById('logged-in-info');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');

    const reviewForm = document.getElementById('review-form');
    const reviewsList = document.getElementById('reviews-list');
    const stars = document.querySelectorAll('.star-rating .star');
    const nameInput = document.getElementById('name');
    const reviewText = document.getElementById('review-text');

    let currentUser = null;
    let selectedRating = 0;

    // Hamburger menu toggle
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    window.onclick = function (event) {
      const menu = document.getElementById('menu');
      if (!event.target.closest('.menu-icon') && !event.target.closest('#menu')) {
        menu.style.display = 'none';
      }
    }

    // Star rating click and keyboard
    stars.forEach((star, idx) => {
      star.addEventListener('click', () => {
        selectedRating = idx + 1;
        updateStars();
      });
      star.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectedRating = idx + 1;
          updateStars();
        }
      });
    });

    function updateStars() {
      stars.forEach((star, idx) => {
        if (idx < selectedRating) {
          star.classList.add('selected');
          star.setAttribute('aria-checked', 'true');
          star.tabIndex = 0;
        } else {
          star.classList.remove('selected');
          star.setAttribute('aria-checked', 'false');
          star.tabIndex = -1;
        }
      });
    }

    // Auth functions
    async function signIn() {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'github' });
      if (error) alert('Login error: ' + error.message);
    }

    async function signOut() {
      const { error } = await supabase.auth.signOut();
      if (error) alert('Logout error: ' + error.message);
    }

    // Update UI based on auth state
    function updateUI(user) {
      currentUser = user;
      if (user) {
        loggedInInfo.style.display = 'inline-block';
        loggedInInfo.textContent = `Logged in as ${user.user_metadata.full_name || user.email || 'User'}`;
        loginButton.style.display = 'none';
        logoutButton.style.display = 'inline-block';
      } else {
        loggedInInfo.style.display = 'none';
        loginButton.style.display = 'inline-block';
        logoutButton.style.display = 'none';
      }
    }

    // Load all reviews
    async function loadReviews() {
      reviewsList.textContent = 'Loading reviews...';
      const { data, error } = await supabase
        .from('reviews')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        reviewsList.textContent = 'Failed to load reviews.';
        console.error(error);
        return;
      }
      if (!data || data.length === 0) {
        reviewsList.textContent = 'No reviews yet.';
        return;
      }

      reviewsList.innerHTML = '';
      data.forEach(review => {
        const reviewEl = document.createElement('div');
        reviewEl.className = 'review';

        // Review header (name + stars + delete if admin)
        const header = document.createElement('div');
        header.className = 'review-header';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'review-name';
        nameSpan.textContent = review.name || 'Anonymous';

        const starsSpan = document.createElement('span');
        starsSpan.className = 'review-stars';
        starsSpan.innerHTML = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);

        header.appendChild(nameSpan);
        header.appendChild(starsSpan);

        // If current user is admin, add delete button
        if (currentUser && adminUIDs.includes(currentUser.id)) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-button';
          delBtn.textContent = '‚úï';
          delBtn.title = 'Delete review';
          delBtn.onclick = () => deleteReview(review.id);
          header.appendChild(delBtn);
        }

        // Review text
        const textDiv = document.createElement('div');
        textDiv.className = 'review-text';
        textDiv.textContent = review.review_text;

        // Date
        const dateDiv = document.createElement('div');
        dateDiv.className = 'review-date';
        const d = new Date(review.created_at);
        dateDiv.textContent = d.toLocaleString();

        reviewEl.appendChild(header);
        reviewEl.appendChild(textDiv);
        reviewEl.appendChild(dateDiv);

        reviewsList.appendChild(reviewEl);
      });
    }

    // Delete review (admin only)
    async function deleteReview(id) {
      if (!confirm('Are you sure you want to delete this review?')) return;
      const { error } = await supabase.from('reviews').delete().eq('id', id);
      if (error) {
        alert('Failed to delete review: ' + error.message);
      } else {
        loadReviews();
      }
    }

    // Handle review form submit
    reviewForm.addEventListener('submit', async e => {
      e.preventDefault();
      if (selectedRating === 0) {
        alert('Please select a star rating.');
        return;
      }
      const name = nameInput.value.trim() || 'Anonymous';
      const review_text = reviewText.value.trim();
      if (review_text.length === 0) {
        alert('Please write a review.');
        return;
      }

      const { error } = await supabase.from('reviews').insert({
        name,
        rating: selectedRating,
        review_text
      });
      if (error) {
        alert('Failed to submit review: ' + error.message);
        return;
      }
      reviewForm.reset();
      selectedRating = 0;
      updateStars();
      loadReviews();
      alert('Thank you for your review!');
    });

    // Listen for auth changes
    supabase.auth.onAuthStateChange((_event, session) => {
      updateUI(session ? session.user : null);
    });

    loginButton.onclick = () => signIn();
    logoutButton.onclick = () => signOut();

    // On page load:
    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      updateUI(user);
      updateStars();
      loadReviews();
    })();
  </script>
</body>
</html>
