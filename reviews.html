<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reviews | HK Window Pros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Roboto', sans-serif; background:#f4f8ff; margin:0; padding:2rem 1rem 4rem; color:#333; }
  header { background: linear-gradient(90deg, #007BFF, #0056b3); color:white; padding:1rem; position:relative; width:100%; box-sizing:border-box; }
  .header-container { max-width:1100px; margin:auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .logo-title a { display:inline-flex; align-items:center; gap:1rem; text-decoration:none; user-select:none; color:white; }
  .logo-title img { height:50px; }
  .logo-title h1 { margin:0; font-weight:700; font-size:1.5rem; }
  .menu-icon { font-size:1.8rem; cursor:pointer; user-select:none; }
  nav { display:none; position:absolute; top:60px; right:1rem; background:#fff; box-shadow:0 4px 8px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden; z-index:1000; width:180px; }
  nav a { display:block; padding:1rem 1.5rem; text-decoration:none; color:#333; font-weight:500; border-bottom:1px solid #eee; transition:background-color 0.3s; }
  nav a:last-child { border-bottom:none; }
  nav a:hover { background:#f4f4f4; }
  h1 { color:#0056b3; margin-bottom:1rem; text-align:center; width:100%; }
  form { background:#fff; padding:1.5rem 2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,86,179,0.1); max-width:500px; width:100%; margin-bottom:2rem; box-sizing:border-box; }
  label { font-weight:700; display:block; margin-top:1rem; margin-bottom:0.5rem; }
  input[type=text], textarea { width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc; font-size:1rem; font-family:inherit; resize:vertical; min-height:60px; box-sizing:border-box; }
  textarea { min-height:80px; }
  .stars { display:flex; gap:8px; font-size:1.8rem; cursor:pointer; user-select:none; }
  .star { color:#ccc; transition:color 0.2s; outline:none; }
  .star.selected, .star:hover, .star.hovered { color:#f4b400; }
  button { margin-top:1.5rem; background:#007BFF; color:#fff; border:none; padding:0.8rem 1.5rem; font-weight:700; font-size:1.1rem; border-radius:10px; cursor:pointer; width:100%; box-shadow:0 5px 15px rgba(0,123,255,0.4); transition:background-color 0.3s; user-select:none; }
  button:hover { background:#0056b3; box-shadow:0 6px 20px rgba(0,86,179,0.6); }
  .reviews-list { max-width:700px; width:100%; background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,86,179,0.1); padding:1.5rem 2rem; box-sizing:border-box; }
  .review-item { border-bottom:1px solid #eee; padding:1rem 0; }
  .review-item:last-child { border-bottom:none; }
  .review-header { font-weight:700; font-size:1.1rem; margin-bottom:0.3rem; color:#003f7f; }
  .review-stars { color:#f4b400; font-size:1.3rem; margin-bottom:0.5rem; }
  .review-text { font-size:1rem; color:#222; white-space: pre-wrap; }
  .review-date { font-size:0.8rem; color:#666; margin-top:0.3rem; }
  .loading { font-size:1.1rem; color:#555; text-align:center; padding:1rem; }
</style>
</head>
<body>
<header>
  <div class="header-container">
    <div class="logo-title">
      <a href="index.html" aria-label="HK Window Pros Home">
        <img src="logo.png" alt="HK Window Pros Logo" />
        <h1>HK Window Pros</h1>
      </a>
    </div>
    <div class="menu-icon" tabindex="0" role="button" aria-label="Toggle menu" onclick="toggleMenu()" onkeydown="if(event.key==='Enter'||event.key===' ')toggleMenu()">
      ☰
    </div>
    <nav id="menu" role="menu" aria-label="Primary navigation menu">
      <a href="index.html" role="menuitem" tabindex="-1">Home</a>
      <a href="quote.html" role="menuitem" tabindex="-1">Get a Quote</a>
      <a href="reviews.html" role="menuitem" tabindex="-1">Reviews</a>
      <a href="login.html" role="menuitem" tabindex="-1">Login</a>
    </nav>
  </div>
</header>

<h1>Customer Reviews</h1>
<form id="reviewForm" aria-label="Submit a review form">
  <label for="name">Name (optional)</label>
  <input type="text" id="name" name="name" placeholder="Your name or leave blank for Anonymous" maxlength="50" autocomplete="name" />

  <label id="rating-label">Rating <span aria-hidden="true" style="color:red;">*</span></label>
  <div class="stars" role="radiogroup" aria-labelledby="rating-label" tabindex="0">
    <span class="star" data-value="1" role="radio" aria-checked="false" tabindex="0" aria-label="1 star">&#9733;</span>
    <span class="star" data-value="2" role="radio" aria-checked="false" tabindex="-1" aria-label="2 stars">&#9733;</span>
    <span class="star" data-value="3" role="radio" aria-checked="false" tabindex="-1" aria-label="3 stars">&#9733;</span>
    <span class="star" data-value="4" role="radio" aria-checked="false" tabindex="-1" aria-label="4 stars">&#9733;</span>
    <span class="star" data-value="5" role="radio" aria-checked="false" tabindex="-1" aria-label="5 stars">&#9733;</span>
  </div>

  <label for="review">Review <span aria-hidden="true" style="color:red;">*</span></label>
  <textarea id="review" name="review" required maxlength="500" placeholder="Write your review here..."></textarea>

  <button type="submit">Submit Review</button>
</form>

<section class="reviews-list" aria-live="polite" aria-relevant="additions" aria-label="List of reviews">
  <div id="loading" class="loading">Loading reviews...</div>
  <div id="reviewsContainer"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://xwdtpqyphfhhnfpadhpv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZHRwcXlwaGZoaG5mcGFkaHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTY0MjIsImV4cCI6MjA2OTgzMjQyMn0.dP_7pajnInXt0p5YJES8yVQcZCP81S4V-rP5ozkTHPQ';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let selectedRating = 0;
    const stars = document.querySelectorAll('.star');
    const loading = document.getElementById('loading');
    const reviewsContainer = document.getElementById('reviewsContainer');

    // Toggle Hamburger menu
    function toggleMenu() {
      const menu = document.getElementById('menu');
      if (menu.style.display === 'block') {
        menu.style.display = 'none';
        Array.from(menu.querySelectorAll('a')).forEach(a => a.tabIndex = -1);
      } else {
        menu.style.display = 'block';
        Array.from(menu.querySelectorAll('a')).forEach(a => a.tabIndex = 0);
      }
    }
    window.toggleMenu = toggleMenu;
    window.onclick = (event) => {
      const menu = document.getElementById('menu');
      if (!event.target.closest('.menu-icon') && !event.target.closest('#menu')) {
        menu.style.display = 'none';
        Array.from(menu.querySelectorAll('a')).forEach(a => a.tabIndex = -1);
      }
    };

    // Star rating event handlers
    stars.forEach((star, i) => {
      star.addEventListener('click', () => {
        selectedRating = parseInt(star.dataset.value);
        console.log('Star clicked:', selectedRating);
        updateStars();
      });
      star.addEventListener('mouseover', () => {
        highlightStars(parseInt(star.dataset.value));
      });
      star.addEventListener('mouseout', () => {
        updateStars();
      });
      star.addEventListener('keydown', (e) => {
        if (e.key === "ArrowRight" || e.key === "ArrowUp") {
          e.preventDefault();
          if (selectedRating < 5) selectedRating++;
          else selectedRating = 1;
          updateStars();
          stars[selectedRating - 1].focus();
        } else if (e.key === "ArrowLeft" || e.key === "ArrowDown") {
          e.preventDefault();
          if (selectedRating > 1) selectedRating--;
          else selectedRating = 5;
          updateStars();
          stars[selectedRating - 1].focus();
        } else if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectedRating = parseInt(document.activeElement.dataset.value);
          updateStars();
        }
      });
    });

    function highlightStars(rating) {
      stars.forEach(star => {
        star.classList.toggle('hovered', parseInt(star.dataset.value) <= rating);
      });
    }
    function updateStars() {
      stars.forEach(star => {
        const val = parseInt(star.dataset.value);
        star.classList.toggle('selected', val <= selectedRating);
        star.setAttribute('aria-checked', val === selectedRating ? 'true' : 'false');
        star.tabIndex = val === selectedRating ? 0 : -1;
      });
    }
    updateStars();

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Format date to readable string
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const d = new Date(timestamp);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Load reviews from supabase
    async function loadReviews() {
      try {
        loading.style.display = 'block';
        reviewsContainer.innerHTML = '';
        const { data, error } = await supabase
          .from('reviews')
          .select('*')
          .order('created_at', { ascending: false });

        loading.style.display = 'none';

        if (error) {
          console.error('Error fetching reviews:', error);
          reviewsContainer.innerHTML = `<p style="color:red;">Error loading reviews.</p>`;
          return;
        }

        if (!data || data.length === 0) {
          reviewsContainer.innerHTML = `<p>No reviews yet. Be the first to submit one!</p>`;
          return;
        }

        data.forEach(review => {
          const name = review.name?.trim() || 'Anonymous';
          const starsHTML = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
          const date = formatDate(review.created_at);

          const div = document.createElement('div');
          div.classList.add('review-item');
          div.innerHTML = `
            <div class="review-header">${escapeHtml(name)}</div>
            <div class="review-stars" aria-label="${review.rating} out of 5 stars">${starsHTML}</div>
            <div class="review-text">${escapeHtml(review.review_text)}</div>
            <div class="review-date">${date}</div>
          `;
          reviewsContainer.appendChild(div);
        });
      } catch (err) {
        loading.style.display = 'none';
        console.error('Unexpected error loading reviews:', err);
        reviewsContainer.innerHTML = `<p style="color:red;">Failed to load reviews.</p>`;
      }
    }

    // Submit review
    document.getElementById('reviewForm').addEventListener('submit', async e => {
      e.preventDefault();

      if (selectedRating === 0) {
        alert('Please select a rating.');
        return;
      }

      const nameInput = document.getElementById('name').value.trim();
      const reviewText = document.getElementById('review').value.trim();

      if (!reviewText) {
        alert('Please enter your review.');
        return;
      }

      try {
        const { error } = await supabase.from('reviews').insert([{
          name: nameInput || 'Anonymous',
          rating: selectedRating,
          review_text: reviewText,
          created_at: new Date().toISOString()
        }]);

        if (error) {
          throw error;
        }

        alert('Thanks for your review!');
        selectedRating = 0;
        updateStars();
        e.target.reset();
        loadReviews();
      } catch (error) {
        console.error('Error submitting review:', error);
        alert('Failed to submit review, please try again later.');
      }
    });

    loadReviews();
  });
</script>
</body>
</html>
